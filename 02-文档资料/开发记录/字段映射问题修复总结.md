# 字段映射问题修复总结

## 问题描述

在内容同步过程中，发现生成的 Markdown 文件的 Frontmatter 字段映射错误：
- `date` 字段被错误地设置为标题内容（如 "海信CES首发玲珑4芯真彩背光"）
- `source` 字段被错误地设置为日期（如 "2026-01-06 20:35"）

## 根本原因

1. **表格解析函数问题**：`parseTableRow` 函数使用 `filter((cell) => cell.length > 0)` 过滤空字符串，导致列索引错位
2. **字段匹配顺序问题**：字段匹配逻辑中，中文列名的匹配顺序不够优化

## 修复方案

### 1. 修复表格解析函数

**修改前：**
```typescript
function parseTableRow(line: string): string[] {
  return line
    .split('|')
    .map((cell) => cell.trim())
    .filter((cell) => cell.length > 0)  // 这会导致列索引错位
}
```

**修改后：**
```typescript
function parseTableRow(line: string): string[] {
  const trimmed = line.trim()
  if (!trimmed.startsWith('|')) {
    return []
  }
  // 移除首尾的 |，然后分割
  const cells = trimmed.slice(1, -1).split('|').map((cell) => cell.trim())
  return cells
}
```

### 2. 优化字段匹配顺序

将中文列名放在匹配条件的最前面，确保优先匹配：
- `normalizedHeader === '抓取时间'` → `row.date`
- `normalizedHeader === '中文标题'` → `row.title`
- `normalizedHeader === '来源'` → `row.source`

### 3. 修复 MDX 解析错误

将内容中的 `<br>` 标签转换为换行符，避免 MDX 解析错误：

```typescript
let fieldContent = row[field]
  .replace(/<br\s*\/?>/gi, '\n')  // 将 <br> 或 <br/> 转换为换行
  .trim()
```

## 验证结果

修复后的日志显示：
- ✅ `date: '2026-01-07 08:03'` - 正确映射到日期
- ✅ `title: '秘光：AI重构Z世代社交关系'` - 正确映射到标题
- ✅ `source: '36氪'` - 正确映射到来源

生成的文件 Frontmatter 格式正确：
```markdown
---
title: "秘光：AI重构Z世代社交关系"
date: 2026-01-07
tags: ["媒体"]
score: 6
source: "36氪"
---
```

## 表格列顺序

根据实际表格结构，列顺序为：
1. 已阅
2. 收藏
3. 序号
4. 评分
5. 类型
6. **来源** (映射到 `source`)
7. **抓取时间** (映射到 `date`)
8. **中文标题** (映射到 `title`)
9. 原标题
10. 字数
11. 命中关键词
12. 金句
13. 水下信息
14. 案例提取
15. 涉及公司

## 相关文件

- `01-源代码/网站代码/app/admin/api/parse-table/route.ts` - 表格解析逻辑
- `01-源代码/网站代码/app/admin/api/sync/route.ts` - 文件同步和内容生成逻辑

## 后续建议

1. **保留调试日志**：当前代码中包含了详细的调试日志，建议在确认稳定后可以移除或改为可选
2. **错误处理**：建议添加更完善的错误处理，特别是对于表格格式异常的情况
3. **字段验证**：建议添加字段格式验证，确保日期格式正确、必填字段存在等


