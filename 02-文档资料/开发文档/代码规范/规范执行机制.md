# 规范执行机制

本文档定义如何确保代码规范在实际开发过程中生效的机制和工具。

## 执行策略

### 1. 自动化检查（最重要）
- **ESLint** - 代码质量检查
- **Prettier** - 代码格式统一
- **TypeScript** - 类型检查
- **Git Hooks** - 提交前自动检查
- **CI/CD** - 持续集成检查

### 2. 工具配置
- 编辑器配置（VS Code）
- 配置文件（.eslintrc、.prettierrc）
- 脚本命令（package.json）

### 3. 流程保障
- 代码审查流程
- 开发检查清单
- 定期规范审查

## 工具配置

### 1. ESLint 配置

**文件位置**: `03-配置文件/.eslintrc.json` 或项目根目录

```json
{
  "extends": [
    "next/core-web-vitals",
    "plugin:@typescript-eslint/recommended",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint"],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn"
  }
}
```

### 2. Prettier 配置

**文件位置**: `03-配置文件/.prettierrc` 或项目根目录

```json
{
  "semi": false,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5",
  "printWidth": 100,
  "arrowParens": "avoid"
}
```

### 3. TypeScript 配置

**文件位置**: `tsconfig.json`（项目根目录）

```json
{
  "compilerOptions": {
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  }
}
```

### 4. EditorConfig

**文件位置**: `.editorconfig`（项目根目录）

```ini
root = true

[*]
charset = utf-8
end_of_line = lf
indent_style = space
indent_size = 2
insert_final_newline = true
trim_trailing_whitespace = true
```

## Git Hooks 配置

### 1. Husky 配置

**安装**:
```bash
npm install --save-dev husky
npx husky install
```

**配置 pre-commit hook**:
```bash
# .husky/pre-commit
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npm run lint
npm run type-check
npm run format-check
```

**配置 commit-msg hook**:
```bash
# .husky/commit-msg
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

npx --no -- commitlint --edit ${1}
```

### 2. Commitlint 配置

**安装**:
```bash
npm install --save-dev @commitlint/cli @commitlint/config-conventional
```

**配置文件**: `commitlint.config.js`
```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'type-enum': [
      2,
      'always',
      [
        'feat',
        'fix',
        'docs',
        'style',
        'refactor',
        'perf',
        'test',
        'chore',
        'content',
      ],
    ],
  },
}
```

## package.json 脚本

```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "lint:fix": "next lint --fix",
    "type-check": "tsc --noEmit",
    "format": "prettier --write \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "format:check": "prettier --check \"**/*.{ts,tsx,js,jsx,json,md}\"",
    "check": "npm run type-check && npm run lint && npm run format:check",
    "pre-commit": "npm run check"
  }
}
```

## VS Code 配置

### 1. 工作区设置

**文件位置**: `.vscode/settings.json`

```json
{
  "editor.formatOnSave": true,
  "editor.defaultFormatter": "esbenp.prettier-vscode",
  "editor.codeActionsOnSave": {
    "source.fixAll.eslint": true,
    "source.organizeImports": true
  },
  "typescript.tsdk": "node_modules/typescript/lib",
  "typescript.enablePromptUseWorkspaceTsdk": true,
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[javascript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[json]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[markdown]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

### 2. 推荐扩展

**文件位置**: `.vscode/extensions.json`

```json
{
  "recommendations": [
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "ms-vscode.vscode-typescript-next"
  ]
}
```

## 代码审查流程

### 1. 提交前检查清单

在提交代码前，确保：

- [ ] 代码通过 `npm run check`（类型检查 + Lint + 格式检查）
- [ ] 所有测试通过（如有）
- [ ] 提交信息符合规范（约定式提交）
- [ ] 没有提交敏感信息（API 密钥、密码等）
- [ ] 没有提交临时文件和备份

### 2. Pull Request 检查清单

创建 Pull Request 时，确保：

- [ ] 代码符合规范（通过 CI 检查）
- [ ] 功能完整且测试通过
- [ ] 文档已更新（如需要）
- [ ] 提交信息清晰描述更改内容
- [ ] 代码审查已完成

### 3. 代码审查要点

审查代码时，检查：

- **类型安全**: 是否充分利用 TypeScript
- **组件设计**: 是否符合组件开发规范
- **命名规范**: 是否符合命名规范
- **代码风格**: 是否符合代码风格规范
- **性能优化**: 是否考虑了性能优化
- **错误处理**: 是否有完善的错误处理

## 开发检查清单

### 每日开发检查

- [ ] 代码通过类型检查
- [ ] 代码通过 Lint 检查
- [ ] 代码格式统一
- [ ] 提交信息符合规范
- [ ] 更新开发记录（每日总结）

### 功能完成检查

- [ ] 功能符合需求
- [ ] 代码符合规范
- [ ] 测试通过（如有）
- [ ] 文档已更新
- [ ] 创建 Checkpoint 记录

## 持续集成（CI）配置

### GitHub Actions 示例

**文件位置**: `.github/workflows/ci.yml`

```yaml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  check:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Type check
        run: npm run type-check
      
      - name: Lint
        run: npm run lint
      
      - name: Format check
        run: npm run format:check
      
      - name: Build
        run: npm run build
```

## 规范执行时间表

### 开发阶段
- **实时检查**: VS Code 编辑器实时提示
- **保存时检查**: 保存时自动格式化
- **提交前检查**: Git Hooks 自动检查

### 代码审查阶段
- **PR 检查**: CI 自动运行检查
- **人工审查**: 代码审查检查清单

### 定期审查
- **每周回顾**: 检查规范执行情况
- **每月优化**: 优化规范和执行机制

## 规范执行优先级

### P0（必须执行）
- TypeScript 类型检查
- ESLint 代码检查
- Git 提交信息规范
- 代码格式统一

### P1（强烈建议）
- Prettier 自动格式化
- Git Hooks 自动检查
- 代码审查流程

### P2（建议）
- CI/CD 自动检查
- 定期规范审查
- 规范培训

## 问题处理

### 规范冲突
如果遇到规范冲突：
1. 优先遵循项目规范
2. 记录冲突情况
3. 讨论解决方案
4. 更新规范文档

### 规范更新
规范需要更新时：
1. 讨论更新内容
2. 更新规范文档
3. 更新工具配置
4. 通知团队成员

## 最佳实践总结

1. **自动化优先**: 尽可能使用自动化工具
2. **工具配置**: 完善的工具配置是基础
3. **流程保障**: 建立清晰的流程和检查清单
4. **持续改进**: 定期审查和优化规范
5. **团队协作**: 确保团队成员了解并遵循规范






